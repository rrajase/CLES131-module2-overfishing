---
title: "Module 2: Overfishing"
format: pdf
editor: source
editor_options: 
  chunk_output_type: console
---

```{r}
#| warning: false
library(tidyverse)
```

### Use of GitHub

Link to your forked GH repository: https://github.com/rrajase/CLES131-module2-overfishing#

### Use of Quarto

Link to your .qmd file: https://github.com/rrajase/CLES131-module2-overfishing/blob/main/module2.qmd

## Overexploitation of global fisheries

We will examine the state of global fisheries and seek to reproduce one of the most widely cited examples of species collapse in order to examine the evidence behind an influential paper on global fisheries, [Worm et al. 2006](https://doi.org/10.1126/science.1132294). However, rather than using the 1950-2003 dataset available to Worm and colleagues in 2006, we will be drawing from more recent stock assessment data to see how the trends have fared, specifically in Atlantic cod.

We also explore how to understand and manipulate tabular data using relational database concepts. Instead of working with a single independent dataframe, as in Module 1, we will be working with a large relational database consisting of tables of different dimensions, but are related through one or more IDs.

## The Database

We will use data from the [RAM Legacy Stock Assessment Database](https://www.ramlegacy.org/database/). Note that the database files are available through Zenodo; please download and unzip the file, moving the .RData file only into your own `data/` folder within this project.

Use the code below to load up the tables in this database.

```{r}
load("data/DBdata[asmt][v4.66].RData")
```

The above function loads all 60 tables of this database, which is a lot! So step one of the data science process is exploring the structure of the database and figuring out how the tables are related.

A selected set of documentation have been provided in `documentation/`. Open up the Database Quickstart Guide for reference as you work through the problems below.

### Q1 (1 point)

One of the main metadata tables is 'stock':

-   How many stocks are there and how many species do they represent?

```{r}
summary(stock)
colnames(stock)
length(unique(stock$scientificname))
```

[There are 1514 stocks representing 398 different species.]{style="color: blue;"}

-   What are the top three most common stocks? (Okay to use common names; these are standardized for fish)

```{r}
sort(count(stock,commonname)$n,decreasing=TRUE)
count(stock,commonname) |>
  filter(n>38)
```

[The top three most common stocks are Chum Salmon, Pink Salmon, and Sockeye salmon.]{style="color: blue;"}

-   In your own words, describe the unit of observation in the 'stock' table and some associated variables that describe it.

[The unit of observation in the stock table is the stock itself, which is described by its id, species name, and region.]{style="color: blue;"}

### Q2 (1 point)

The next main metadata table is 'assessment':

-   What is the unit of observation in the 'assessment' table? How is this related to the unit of observation in the 'stock' table?

[The unit of observation in the assessment table is each assessment, described by the assessor, and information provided. This is related to each stock in the stock table as each assessment is associated with a specific stock by its id.]{style="color: blue;"}

-   It seems like 'stockid' and 'assessyear' might uniquely identify each assessment. Is this the case? If not, why not?

```{r}
assessment |>
  count(stockid, assessyear) |>
  filter(n>1) # 48 have 2

assessment |>
  filter(stockid == "ANCHIXa" & assessyear == "1989-2016") |> # see what is different between both entries
  view() # date recorded and loaded are different!

assessment |>
  count(assessid) |>
  filter(n>1) # length 0, each id is unique
```

[Stockid and assessyear do not uniquely identify each assessment, as some entries have different dates that the data was recorded for that assessment. An actual unique identifier is the assessid.]{style="color: blue;"}

-   Which variable(s) might you use to join 'stock' and 'assessment'?

```{r}
intersect(colnames(stock), colnames(assessment))
```

[One variable that could be used to join 'stock' and 'assessment' could be the stockid. Each assessment is done on one stock, which each have a unique id in the stock table. We could do a left join between 'assessment' and 'stock' with the stockid to add full stock info from 'stock' to 'assessment'.]{style="color: blue;"}

### Q3 (1 point)

In section B of the Database Quick Guide, additional metadata tables are listed in section B. With your data exploration skills, complete the following table:

| B table | Associated table | join column from B | join column from other |
|----|----|----|----|
| area | stock | areaid | areaid |
| assessmethod | assessment | methodshort | assessmethod |
| assessor | assessment | assessorid | assessorid |
| management | stock, through area | mgmt, management -\> areatype, area | areaid, area -\> areaid, stock |
| taxonomy | stock | tsn | tsn |

\*Note that assessmethod is not a data.frame, which was perhaps an oversight; consider turning it into one for the ease of using tidyverse functions.

```{r}
assessmethod <- as.data.frame(assessmethod)

intersect(colnames(stock), colnames(area)) # areaid
intersect(colnames(assessment), colnames(assessmethod)) # diff name, methodshort in assessmethod = assessmethod in assessment
intersect(colnames(assessment), colnames(assessor)) # assessorid
intersect(colnames(stock), colnames(management)) # no direct, mgmt in management = areatype in area
intersect(colnames(stock), colnames(taxonomy)) # tsn, scientific name
```

### Q4 (1 point)

There are two main data tables described in section C, but their key attributes are difficult to understand. Join the two main data tables with their respective metrics tables (section D):

```{r}
intersect(colnames(bioparams), colnames(biometrics)) # diff names, bioid and biounique
bioparamsMetrics <- bioparams |> 
  left_join(biometrics, join_by(bioid == biounique))

intersect(colnames(timeseries), colnames(tsmetrics)) # diff names, tsid and tsunique
timeseriesMetircs <- timeseries |> 
  left_join(tsmetrics, join_by(tsid == tsunique))
```

-   Briefly describe the contents of each joined table.

[The joined bioparams table contains records of different metrics for each stock, such as maximum age or mortality rate. The joined timeseries table contains similar records of non-biological related metrics for each stock, such as catch size. Both tables contain multiple entries for each stock, where each row contains a value for a different metric.]{style="color: blue;"}

-   What is accomplished by joining these tables?

[By joining these tables, we can connect the description of a metric based on its id, giving meaning to each value which is listed in the original data tables.]{style="color: blue;"}

## Overexploitation of Atlantic cod

This database is clearly complex and contains a lot of information. We've grappled with its high dimensionality by exploring and joining tables above. Next, we will take a "bottom-up" approach and evaluate a single species, Atlantic cod. Read this [book chapter](https://pressbooks.pub/extinctionstories/chapter/atlantic-cod/) on Atlantic cod, which serves as a reference for the following questions.

### Q5 (1 point)

The collapse of the Atlantic cod fisheries is well documented. Let's see if we can visualize that decline with this database.

-   How many unique fish stocks comprise "Atlantic cod" and what regions do they come from?

```{r}
cod <- stock |>
  filter(commonname == "Atlantic cod")

count(cod)
unique(cod$region)
```

[There are 28 unique fish stocks comprising of Atlantic cod, and they come from the Canadian East Coast, the US East Coast, and in Europe.]{style="color: blue;"}

Create a vector of the 'stockid' associated with "Atlantic cod". Then turn your attention to the previously-joined timeseries/tsmetrics table and create a subsetted dataframe with only observations of "Atlantic cod" that have a non-NA value. This table reports many years and many metrics, while we are primarily interested in the years since 1950.

```{r}
codId <- cod$stockid

codTs <- timeseriesMetircs |>
  filter(stockid %in% codId & tsyear > 1950) |>
  view()
```

-   Which metrics are most commonly reported for Atlantic cod in this timeframe and what do they mean?

```{r}
codTs |>
  count(tslong) |>
  view()
```

[The most commonly reported metrics are 'Catch divided by mean catch', 'General total Catch', and 'Total landings'. Each metric shows represents a different value of each stock, in this case: the catch size relative to the average, the total catch size, and total landings.]{style="color: blue;"}

### Q6 (1 point)

Make a timeseries figure for each stock of Atlantic cod. Rather than coloring by the identity of the stock, color by the region it comes from (this may require joining). Use `facet_*()` to plot both metrics in a single code chunk. Connect the points for each stock and focus on the period since 1950. Update until the figure is easily interpretable.

```{r}
codMetrics <- cod |>
  left_join(timeseriesMetircs, join_by(stockid)) |>
  filter(tsyear > 1950) |>
  filter(is.na(tsvalue) == FALSE)

count(codMetrics,tsid)

ggplot(codMetrics, aes(x = tsyear, y = tsvalue, color = region)) +
  geom_line() +
  geom_point() +
  facet_wrap(~tslong, nrow=5) +
  ylim(0,1e+08)

unique(codMetrics$tslong)
```

-   What happened to Atlantic cod stocks during the period 1950-present? What information does each metric convey?

[Looking at each 44 metrics, the ones which have interesting plots are 'Total abundance', 'Recruits', 'Spawning Stock Biomass', and 'Fishery-independent survey abundance'. Since each plot is within the same domain, all of the catch-related plots have points much smaller than 1e08 to display any useful trends.]{style="color: blue;"}

### Q7 (1 point)

We will recreate a slightly more complex version of a figure from the [Millennium Ecosystem Assessment](https://www.millenniumassessment.org/documents/document.356.aspx.pdf) (Fig. 11).

Selecting a metric that can be added across stocks, calculate the total fish landings for each region of Atlantic cod. Make a plot similar to Fig. 11 and color by region.

```{r}
codLandings <- codMetrics |>
  filter(tslong == "Total landings")

ggplot(codLandings, aes(x = tsyear, y = tsvalue, color = region)) +
  geom_line() +
  geom_point()

```

Which region does Fig. 11 from the MEA correspond to?

[Fig. 11 corresponds the the Canadian East Coast, specifically Newfoundland.]{style="color: blue;"}

### Q8 (1 point)

Under the Management Policies section of the [book chapter](https://pressbooks.pub/extinctionstories/chapter/atlantic-cod/), the authors summarize a few major efforts to restore and protect stocks of Atlantic cod. Focusing only on the US and Canada, update your plot from above to include vertical lines to represent the timing of least three major events and label them clearly on your plot. Doing so will likely involve creating a separate dataframe and using it in one of your ggplot layers (one possible argument within `aes()` is `linetype`). Facet the plot by region and update until it is easily interpretable.

```{r}
codLandingsReg <- codLandings |>
  filter(region == "Canada East Coast" | region == "US East Coast")

ggplot(codLandingsReg, aes(x = tsyear, y = tsvalue, color = region)) +
  geom_line() +
  geom_point() +
  geom_vline(xintercept=1996, linetype="dashed", color="black", size=0.5) +
  annotate("text", x=1996, y=7e+05, label= "Cod  listed as a \nvulnerable species") + 
  geom_vline(xintercept=1986, linetype="dashed", color="black", size=0.5) +
  annotate("text", x=1986, y=5e+05, label= " Northeast \nMultispecies \nFishery Management \nPlan developed") + 
  geom_vline(xintercept=1958, linetype="dashed", color="black", size=0.5) +
  annotate("text", x=1958, y=7e+05, label= "Trawlers fish \nin deeper \nparts of \nstock.")

```

### Q9 (2 points)

What happened to Atlantic cod stocks for each region following each piece of legislation or management plan, and why do you think this was so? Your multi-paragraph answer should be informed by content from the book chapter; additional sources are optional, and all sources should be cited.

[Going off of the plot, after trawlers started fishing in deeper parts of stock, there was a sharp increase in landings. However, likely due to unsustainable practices, \~1970, landings started to decrease. This steady decrease led to the creation of the Northeast Multispecies Fishery Management Plan (NMFMP). After this, we can see a slight increase in landings, however it changes to a shart decrease around 1990, until cod are officially listed as a vulnerable species in 1996.]{style="color: blue;"}

[Reading the chapter, we can see this sharp decrease is concerning, as cod are an essential part of their ecosystem. After trawlers led to more landings, "there was a decrease in the number of fish... \[and\] the population was unable to replenish the stock." In addition to overfishing and other human activity, populations declined due to pollution and changes in climate. Efforts to curb these effects started in the 70s with the Magnuson-Stevens Fishery Conservation and Management Act (MSFCMA). However, this act which protected from foreign fishing didn't do much to curb overfishing, and led to the eventual listing of cod as a vulnerable species.]{style="color: blue;"}

[These acts have been reinstated from 2006 and onwards to designate specific fishing-free zones, and new research has been done to see what practices are really part of the problem. Until these root causes are addressed, there will likely be a continued decrease.]{style="color: blue;"}

[Sources: NOAA - https://www.fisheries.noaa.gov/resource/document/magnuson-stevens-fishery-conservation-and-management-act]{style="color: blue;"}
